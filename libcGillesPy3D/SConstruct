import distutils.sysconfig
import os


# Make sure python3 dev headers are installed
# On Ubuntu, python3-dev (might need version-specific, e.g. python3.11-dev, which might require adding new repos)
# On Fedora, python3-devel (might need version-specific, e.g. python3.11-devel)
pyinc = distutils.sysconfig.get_python_inc()

env = Environment(
    CXXFLAGS=[
        "-std=c++17",
        "-fPIC",
    ],
    TOOLS=[
        "default",
        "swig",
    ],
    SWIGOUTDIR=Dir("lib"),
    CPPPATH=[
        Dir("include"),
        Dir("external/ANN/include"),
        Dir("external/Sundials/include"),
        Dir("external/Sundials/src"),
        Dir("external/Sundials/cmake-build/default/include"),
        Dir("external/Sundials/src/sundials"),
        pyinc,
    ],
    LIBPATH=[
        Dir("obj"),
        Dir("obj/external/Sundials"),
    ],
    ENV=os.environ,
)

# Send dependency build files to obj/ subfolders
# From this point on, refer to all source files as being relative to the build directory
# SCons will automagically map your build-relative file to the real path
VariantDir("obj/src", "src", duplicate=False)
VariantDir("obj/external", "external", duplicate=False)
VariantDir("obj/include", "include", duplicate=False)

cgillespy3d = SConscript("obj/src/SConscript", exports=["env"])
sundials = SConscript("obj/external/Sundials/SConscript", exports=["env"])

libcgillespy3d = env.StaticLibrary(
    "lib/cgillespy3d",
    ["obj/include/libcgillespy3d.i", *cgillespy3d, *sundials],
    SWIGFLAGS=[
        "-c++",
        "-python",
        "-features",
        "autodoc",
    ],
    SWIGCXXFILESUFFIX="_wrap.cpp",
)
